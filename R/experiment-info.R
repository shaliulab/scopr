#' Retrieve information about an experiment
#'
#' This function is used to obtain experimental information -- such as *time and date* of the experiment,
#' *acquisition device*, and *version of the software* --
#' embedded in a result file (`.db`) generated by the ethoscope platform.
#'
#' @param FILE the name of the input file
#' @return a list containing fields for metadata entries
#' @seealso
#' * [load_ethoscope] -- to load the actual data
#' * [list_result_files] -- to list available files
#' @export
experiment_info <- function(FILE){
  con <- RSQLite::dbConnect(RSQLite::SQLite(), FILE, flags=RSQLite::SQLITE_RO)
  tryCatch(
    {metadata <- RSQLite::dbGetQuery(con, "SELECT * FROM METADATA")},
    finally={RSQLite::dbDisconnect(con)})

  if (nrow(metadata) == 0) {
    warning(paste0("sqlite3 file ", FILE, "has an empty METADATA table"))
    v <- list()
    # this assumes the folder the dbfile lives in is the datetime when the experiment started, which should be true in a normal case
    # the format of the datetime is YYYY-MM-DD_HH-MM-SS
    date_time_str <- rev(unlist(strsplit(dirname(FILE), split ="/")))[1]
    v$date_time <- as.POSIXct(date_time_str, tz="GMT", format="%Y-%m-%d_%H-%M-%S")
  } else {
    v <- as.list(metadata$value)
    names(v) <- metadata$field
    #fixme explicitly GMT
    v$date_time <- as.POSIXct(as.integer(v$date_time),origin="1970-01-01",tz = "GMT")
  }
  return(v)
}
