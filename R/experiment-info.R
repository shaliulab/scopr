#' Retrieve information about an experiment
#'
#' This function is used to obtain experimental information -- such as *time and date* of the experiment,
#' *acquisition device*, and *version of the software* --
#' embedded in a result file (`.db`) generated by the ethoscope platform.
#'
#' @param FILE the name of the input file
#' @return a list containing fields for metadata entries
#' @seealso
#' * [load_ethoscope] -- to load the actual data
#' * [list_result_files] -- to list available files
#' @export
experiment_info <- function(FILE){

  # Connect to the result file (`.db`)
  con <- dbConnectFriendly(FILE)

  # Try reading the METADATA table
  tryCatch({
    metadata <- RSQLite::dbGetQuery(con, "SELECT * FROM METADATA")

  # Make sure we disconnect even if the above command is unsuccessful
  # to keep the state of the database
  }, finally = {
    RSQLite::dbDisconnect(con)
  })

  # Generate a named list using the value column for the values
  # and the field column for the names
  v <- as.list(metadata$value)
  names(v) <- metadata$field

  # Format the timestamp available in the date_time field
  # to a nice readable string compatible with format() with format:
  # %Y-%m-%d %H-%M-%S %Z
  # use the same reference the timestamp has
  # the timestamp was computed using either
  # * the wall_clock with time.time() in Python 3 returning seconds since 1970-01-01 00:00:00 GMT
  # * using the offset between the parsed start_time and the same reference in 1970 (FSLVirtualCamera)
  # thus in either case, the timestamp has the same origin and it can be safely formatted back
  v$date_time <- as.POSIXct(as.integer(v$date_time), origin = "1970-01-01", tz = "GMT")
  return(v)
}
